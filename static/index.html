<html>
	<head>
        <title>Random movie</title>
        <link rel="stylesheet" href="/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/css/bootstrap-theme.min.css" />
        <script src="/js/jquery.min.js" type="text/javascript"></script>
        <script src="/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/js/mithril.min.js" type="text/javascript"></script>
    </head>
	<body>

    </body>
    <script>

    var Movie = {
        getRandom: function() {
            return m.request({ method: "GET", url: "/api/" });
        },
        addNew: function(title) {
            return m.request({ method: "POST", url: "/api/", data: { title: title } });
        }

    };

    var MovieComponent = {
        controller: function(){

            var movie = m.prop({});
            var newTitle = m.prop("");

            function nextMovie(e) {
                e.preventDefault();
                Movie.getRandom().then(movie);
            }

            function addMovie(e) {
                e.preventDefault();

                var title = newTitle().trim();
                if (title) {
                    newTitle("");
                    Movie.addNew(title).then(movie);
                }
            }

            Movie.getRandom().then(movie);

            return {
                'movie': movie,
                'newTitle': newTitle,
                'nextMovie': nextMovie,
                'addMovie': addMovie
            };
        },
        view: function(ctrl){
            var movie = ctrl.movie();

            function showPoster() {
                if (movie.Poster == 'N/A') {
                    return m("b", "No poster available")
                }
                return m("a[target=_blank]", {href: imdbURL},  m("img.img-responsive", {src: movie.Poster}));
            }

            function showMovie() {

                var nextBtn = m("button.btn.btn-primary", {onclick: ctrl.nextMovie}, "Show me another");
                if (!movie || !movie.Title || !movie.Poster) {
                    return nextBtn;
                }

                return m("div.row", [
                    m("div.col-md-6", [
                        showPoster()
                    ]),
                    m("div.col-md-6", [
                        m("h2", m("a[target=_blank]", {href: imdbURL}, movie.Title)),
                        m("dl.dl-unstyled", [
                            m("dt", "Year"),
                            m("dd", movie.Year),
                            m("dt", "Actors"),
                            m("dd", movie.Actors),
                            m("dt", "Director"),
                            m("dd", movie.Director),
                        ]),
                        m("p.well", movie.Plot),
                        nextBtn
                    ])
                ]);
            }
            var imdbURL = "http://www.imdb.com/title/" +  movie.imdbID + "/";
            return m("div.container", [
                m("h1", "Random movies"),
                m("form.form-horizontal", {onsubmit: ctrl.addMovie}, [
                    m("div.form-group", [
                        m("input.form-control.form-control-bg", {
                            type: "text",
                            placeholder: "Add another title",
                            value: ctrl.newTitle(),
                            onchange: m.withAttr("value", ctrl.newTitle)
                        }),
                        m("button.form-control.btn.btn-primary[type=submit]", "Add")
                    ])
                ]),
                showMovie()
            ]);
        }
    };

    m.mount(document.body, MovieComponent);

    </script>


</html>
